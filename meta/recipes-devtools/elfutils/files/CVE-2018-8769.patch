From 92581d7eb483cb039e60112b0a03a04c2ffa4df4 Mon Sep 17 00:00:00 2001
From: Mark Wielaard <mark@klomp.org>
Date: Fri, 16 Mar 2018 19:42:17 +0100
Subject: [PATCH] libebl: Handle SYMTAB_SHNDX in ebl_dynamic_tag_name.

SYMTAB_SHNDX was introduced when elf.h was imported, but not yet handled
in ebl_dynamic_tag_name. Handle it and add an eu_static_assert to make
sure stdtags always contains DT_NUM entries.

https://sourceware.org/bugzilla/show_bug.cgi?id=22976

CVE: CVE-2018-8769
Upstream-Status: Backport [https://sourceware.org/git/?p=elfutils.git;a=commit;h=92581d7eb483cb039e60112b0a03a04c2ffa4df4]

Signed-off-by: Mark Wielaard <mark@klomp.org>
Signed-off-by: Jagadeesh Krishnanjanappa <jkrishnanjanappa@mvista.com>
---
 libebl/ChangeLog           | 6 ++++++
 libebl/ebldynamictagname.c | 4 +++-
 2 files changed, 9 insertions(+), 1 deletion(-)

diff -Naurp elfutils-0.170_org/libebl/ChangeLog elfutils-0.170/libebl/ChangeLog
--- elfutils-0.170_org/libebl/ChangeLog	2017-08-02 05:06:25.000000000 -0700
+++ elfutils-0.170/libebl/ChangeLog	2018-07-23 08:46:01.178603179 -0700
@@ -1,3 +1,9 @@
+2018-03-16  Mark Wielaard  <mark@klomp.org>
+
+	* ebldynamictagname.c (ebl_dynamic_tag_name): Add SYMTAB_SHNDX to
+	stdtags. Add a eu_static_assert to make sure stdtags contains all
+	DT_NUM entries.
+
 2017-07-19  Gustavo Romero <gromero@linux.vnet.ibm.com>
 
 	* eblcorenotetypename.c: Add ppc64 HTM SPRs note as known type.
diff --git a/libebl/ebldynamictagname.c b/libebl/ebldynamictagname.c
index 3aaccd0..5622fc3 100644
--- a/libebl/ebldynamictagname.c
+++ b/libebl/ebldynamictagname.c
@@ -34,6 +34,7 @@
 #include <inttypes.h>
 #include <stdio.h>
 #include <libeblP.h>
+#include "system.h"
 
 
 const char *
@@ -53,8 +54,9 @@ ebl_dynamic_tag_name (Ebl *ebl, int64_t tag, char *buf, size_t len)
 	      "RELENT", "PLTREL", "DEBUG", "TEXTREL", "JMPREL", "BIND_NOW",
 	      "INIT_ARRAY", "FINI_ARRAY", "INIT_ARRAYSZ", "FINI_ARRAYSZ",
 	      "RUNPATH", "FLAGS", "ENCODING", "PREINIT_ARRAY",
-	      "PREINIT_ARRAYSZ"
+	      "PREINIT_ARRAYSZ", "SYMTAB_SHNDX"
 	    };
+	  eu_static_assert (sizeof (stdtags) / sizeof (const char *) == DT_NUM);
 
 	  res = stdtags[tag];
 	}
-- 
1.8.3.1

